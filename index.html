<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kassa Pro Ultra v15</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root { --main: #27ae60; --bg: #f4f7f6; --dark: #2c3e50; --danger: #e74c3c; --edit: #f39c12; }
        
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding-bottom: 160px; 
            user-select: none;
        }

        /* Sahifalar */
        .page { display: none; padding: 15px; animation: fadeIn 0.2s; }
        .active-page { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Grid Dizayn */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .prod-card { 
            background: white; padding: 20px 10px; border-radius: 12px; 
            text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #eee; height: 110px; display: flex;
            flex-direction: column; justify-content: center; box-sizing: border-box;
        }
        .prod-card:active { transform: scale(0.95); background: #f9f9f9; }
        .prod-name { font-weight: bold; font-size: 18px; color: var(--dark); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .prod-price { color: var(--main); font-weight: 800; font-size: 17px; margin-top: 5px; }

        /* Tugmalar va Navigatsiya */
        .floating-pay-btn {
            position: fixed; bottom: 85px; left: 5%; width: 90%; height: 60px;
            background: var(--dark); color: white; border-radius: 15px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            border: none; z-index: 999; box-sizing: border-box; font-size: 16px;
        }
        .nav { 
            position: fixed; bottom: 0; width: 100%; height: 70px;
            background: white; display: flex; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000;
        }
        .nav-item { 
            flex: 1; display: flex; flex-direction: column; align-items: center; 
            justify-content: center; font-weight: bold; color: #7f8c8d; font-size: 13px;
        }
        .nav-active { color: var(--main); border-top: 4px solid var(--main); background: #fafafa; }

        /* Elementlar */
        input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 18px; box-sizing: border-box; }
        .btn { background: var(--main); color: white; border: none; padding: 15px; border-radius: 10px; width: 100%; font-weight: bold; font-size: 16px; cursor: pointer; }
        .list-item { display: flex; justify-content: space-between; background: white; padding: 15px; margin-bottom: 8px; border-radius: 10px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }

        /* Modal */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index: 1100; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; padding: 25px; border-radius: 15px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="salePage" class="page active-page">
        <h2 style="text-align:center; color: var(--dark);">üõí Savdo Terminali</h2>
        <div id="productGrid" class="grid"></div>
        <button class="floating-pay-btn" onclick="showReceipt()">
            <span>Savatda: <b id="cartCount">0</b> ta</span>
            <span>üí∞ YAKUNLASH</span>
        </button>
    </div>

    <div id="prodPage" class="page">
        <h3 style="text-align:center" id="prodFormTitle">üì¶ Mahsulot Qo'shish</h3>
        <div style="background: white; padding: 15px; border-radius: 15px;">
            <input type="hidden" id="editOldName">
            <input type="text" id="pName" placeholder="Mahsulot nomi">
            <input type="number" id="pPrice" placeholder="Narxi (1 kg)">
            <button class="btn" onclick="saveProduct()">‚úÖ Saqlash</button>
            <button id="cancelBtn" class="btn" style="background:#95a5a6; margin-top:5px; display:none;" onclick="resetForm()">Bekor qilish</button>
        </div>
        <div id="inventoryList" style="margin-top:20px;"></div>
    </div>

    <div id="historyPage" class="page">
        <h3 style="text-align:center">üìú Savdo Tarixi</h3>
        <button class="btn" style="background: var(--edit); margin-bottom: 15px;" onclick="exportToExcel()">üì• Professional Excel Hisoboti</button>
        <div id="historyLogs"></div>
    </div>

    <div id="weightModal" class="modal">
        <div class="modal-content" style="text-align:center">
            <h3 id="selectedName"></h3>
            <input type="number" id="vaznField" placeholder="0.00 kg" step="0.01">
            <button class="btn" onclick="confirmWeight()">Savatga qo'shish</button>
            <button class="btn" style="background:var(--danger); margin-top:10px;" onclick="closeModal('weightModal')">Yopish</button>
        </div>
    </div>

    <div id="chekModal" class="modal">
        <div class="modal-content">
            <center><h3>XARID CHEKI</h3></center>
            <div id="chekItems" style="max-height: 250px; overflow-y: auto; font-family: monospace; margin: 15px 0;"></div>
            <hr>
            <div style="text-align:right; font-weight:bold; font-size:22px;">JAMI: <span id="chekTotal" style="color:var(--danger)"></span></div>
            <button class="btn" style="margin-top:20px;" onclick="finishSale()">‚úÖ Tasdiqlash</button>
            <button class="btn" style="background:var(--danger); margin-top:10px;" onclick="closeModal('chekModal')">Yopish</button>
        </div>
    </div>

    <div class="nav">
        <div class="nav-item nav-active" onclick="openTab('salePage', this)">üõí<span>SOTUV</span></div>
        <div class="nav-item" onclick="openTab('prodPage', this)">üì¶<span>OMBOR</span></div>
        <div class="nav-item" onclick="openTab('historyPage', this)">üìú<span>TARIX</span></div>
    </div>

<script>
    let db, cart = [], selected = null;
    const formatMoney = n => n.toLocaleString('fr-FR').replace(/,/g, ' ');

    const req = indexedDB.open("KassaDB_Professional_v15", 1);
    req.onupgradeneeded = e => {
        let d = e.target.result;
        d.createObjectStore("items", { keyPath: "name" });
        d.createObjectStore("sales", { autoIncrement: true });
    };
    req.onsuccess = e => { db = e.target.result; renderGrid(); renderInventory(); renderHistory(); };

    function openTab(tabId, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('nav-active'));
        document.getElementById(tabId).classList.add('active-page');
        el.classList.add('nav-active');
    }

    function saveProduct() {
        let name = document.getElementById('pName').value, price = parseFloat(document.getElementById('pPrice').value), old = document.getElementById('editOldName').value;
        if(!name || !price) return;
        let tx = db.transaction("items", "readwrite"), store = tx.objectStore("items");
        if(old && old !== name) store.delete(old);
        store.put({ name, price });
        tx.oncomplete = () => { resetForm(); renderGrid(); renderInventory(); };
    }

    function editItem(name, price) {
        document.getElementById('pName').value = name; document.getElementById('pPrice').value = price;
        document.getElementById('editOldName').value = name; document.getElementById('prodFormTitle').innerText = "‚úèÔ∏è Tahrirlash";
        document.getElementById('cancelBtn').style.display = 'block'; window.scrollTo(0,0);
    }

    function resetForm() {
        document.getElementById('pName').value = ''; document.getElementById('pPrice').value = '';
        document.getElementById('editOldName').value = ''; document.getElementById('prodFormTitle').innerText = "üì¶ Mahsulot Qo'shish";
        document.getElementById('cancelBtn').style.display = 'none';
    }

    function renderInventory() {
        const list = document.getElementById('inventoryList'); list.innerHTML = '';
        db.transaction("items").objectStore("items").getAll().onsuccess = e => {
            e.target.result.forEach(p => {
                list.innerHTML += `<div class="list-item"><span><b>${p.name}</b><br><small>${formatMoney(p.price)}</small></span>
                <div><button onclick="editItem('${p.name}', ${p.price})" style="background:var(--edit); color:white; border:none; padding:10px; border-radius:8px;">‚úèÔ∏è</button>
                <button onclick="deleteItem('${p.name}')" style="background:var(--danger); color:white; border:none; padding:10px; border-radius:8px; margin-left:5px;">üóë</button></div></div>`;
            });
        };
    }

    function deleteItem(name) { if(confirm("O'chirilsinmi?")) { db.transaction("items", "readwrite").objectStore("items").delete(name); renderGrid(); renderInventory(); } }

    function renderGrid() {
        const grid = document.getElementById('productGrid'); grid.innerHTML = '';
        db.transaction("items").objectStore("items").getAll().onsuccess = e => {
            e.target.result.forEach(p => {
                grid.innerHTML += `<div class="prod-card" onclick="openWeight('${p.name}', ${p.price})"><div class="prod-name">${p.name}</div><div class="prod-price">${formatMoney(p.price)}</div></div>`;
            });
        };
    }

    function openWeight(name, price) { selected = { name, price }; document.getElementById('selectedName').innerText = name; document.getElementById('weightModal').style.display = 'flex'; document.getElementById('vaznField').focus(); }

    function confirmWeight() {
        let w = parseFloat(document.getElementById('vaznField').value); if(!w) return;
        cart.push({ ...selected, weight: w, total: selected.price * w });
        document.getElementById('cartCount').innerText = cart.length; closeModal('weightModal'); document.getElementById('vaznField').value = '';
    }

    function showReceipt() {
        if(!cart.length) return; let total = 0;
        let html = cart.map(i => { total += i.total; return `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${i.name} (${i.weight}kg)</span><b>${formatMoney(i.total)}</b></div>`; }).join('');
        document.getElementById('chekItems').innerHTML = html; document.getElementById('chekTotal').innerText = formatMoney(total) + " so'm"; document.getElementById('chekModal').style.display = 'flex';
    }

    function finishSale() {
        let total = cart.reduce((a, b) => a + b.total, 0);
        db.transaction("sales", "readwrite").objectStore("sales").add({ date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString(), items: [...cart], total: total });
        cart = []; document.getElementById('cartCount').innerText = "0"; closeModal('chekModal'); renderHistory(); alert("Saqlandi!");
    }

    function renderHistory() {
        const logs = document.getElementById('historyLogs'); logs.innerHTML = '';
        db.transaction("sales").objectStore("sales").getAll().onsuccess = e => {
            e.target.result.reverse().forEach(h => {
                logs.innerHTML += `<div class="list-item" style="border-left:5px solid var(--main)"><small>${h.date} ${h.time}</small><b>${formatMoney(h.total)} so'm</b></div>`;
            });
        };
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // üèÜ MUKAMMAL EXCEL EKSPORT (GORIZONTAL + JAMI)
    function exportToExcel() {
        db.transaction("sales").objectStore("sales").getAll().onsuccess = e => {
            const sales = e.target.result;
            if (!sales.length) return alert("Ma'lumot topilmadi!");

            let data = [];
            let merges = [];
            let row1 = [], row2 = [];
            let productBlocks = {};

            // 1. Guruhlash
            sales.forEach(sale => {
                sale.items.forEach(item => {
                    if (!productBlocks[item.name]) productBlocks[item.name] = [];
                    productBlocks[item.name].push({ time: sale.date + " " + sale.time, weight: item.weight, total: item.total });
                });
            });

            let productNames = Object.keys(productBlocks);
            let maxRows = 0;
            
            productNames.forEach((pName, index) => {
                let startCol = index * 3;
                row1[startCol] = pName;
                merges.push({ s: { r: 0, c: startCol }, e: { r: 0, c: startCol + 2 } });
                row2[startCol] = "Vaqt"; row2[startCol+1] = "Vazn (kg)"; row2[startCol+2] = "Summa (so'm)";
                if (productBlocks[pName].length > maxRows) maxRows = productBlocks[pName].length;
            });

            data.push(row1); data.push(row2);

            // 2. Ma'lumotlarni yonma-yon qo'shish
            for (let r = 0; r < maxRows; r++) {
                let row = [];
                productNames.forEach((pName, index) => {
                    let startCol = index * 3;
                    let itemData = productBlocks[pName][r];
                    if (itemData) {
                        row[startCol] = itemData.time;
                        row[startCol + 1] = itemData.weight;
                        row[startCol + 2] = itemData.total;
                    }
                });
                data.push(row);
            }

            // 3. JAMI HISOB-KITOB QATORI
            data.push([]); // Bo'sh qator
            let totalRow = [];
            productNames.forEach((pName, index) => {
                let startCol = index * 3;
                let tWeight = productBlocks[pName].reduce((s, i) => s + i.weight, 0);
                let tSum = productBlocks[pName].reduce((s, i) => s + i.total, 0);
                totalRow[startCol] = "JAMI:";
                totalRow[startCol+1] = tWeight.toFixed(2);
                totalRow[startCol+2] = tSum;
            });
            data.push(totalRow);

            // Excel yaratish
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!merges'] = merges;
            ws['!cols'] = row2.map(() => ({ wch: 18 }));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Hisobot");
            XLSX.writeFile(wb, `Kassa_Hisobot_${new Date().toLocaleDateString()}.xlsx`);
        };
    }
</script>
</body>
</html>
