<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kassa Pro Elite v26</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        :root { --main: #10b981; --bg: #f8fafc; --dark: #1e293b; --danger: #ef4444; --edit: #f59e0b; --blue: #3b82f6; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding-bottom: 150px; color: var(--dark); overflow-x: hidden; }
        
        .page { display: none; padding: 20px; box-sizing: border-box; }
        .active-page { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .prod-card { background: #fff; padding: 18px 12px; border-radius: 16px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; transition: 0.1s; }
        .prod-card:active { transform: scale(0.95); }

        /* Navigatsiya */
        .nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: #fff; display: flex; border-top: 1px solid #e2e8f0; z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 600; color: #94a3b8; font-size: 11px; }
        .nav-active { color: var(--main); }

        /* Floating Controls */
        .action-bar { position: fixed; bottom: 80px; left: 15px; right: 15px; display: flex; gap: 10px; z-index: 999; transition: 0.3s; }
        .btn-cart { flex: 1; background: var(--blue); color: white; border: none; border-radius: 14px; height: 55px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); }
        .btn-pay { flex: 2; background: var(--dark); color: white; border: none; border-radius: 14px; height: 55px; font-weight: 700; font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .hidden-bar { transform: translateY(150px); opacity: 0; }

        /* Modallar */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 1100; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 92%; padding: 25px; border-radius: 24px; max-height: 85vh; overflow-y: auto; box-sizing: border-box; }
        .btn { background: var(--main); color: white; border: none; padding: 14px; border-radius: 12px; width: 100%; font-weight: 700; cursor: pointer; }
        
        .list-item { display: flex; justify-content: space-between; background: white; padding: 16px; margin-bottom: 10px; border-radius: 16px; border: 1px solid #f1f5f9; align-items: center; }
        
        /* Savat va Chek */
        .receipt { font-family: 'Courier New', monospace; }
        .cart-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .edit-btn { background: #f1f5f9; border: none; padding: 8px; border-radius: 8px; margin-left: 5px; }
    </style>
</head>
<body>

    <div id="salePage" class="page active-page">
        <h2 style="margin:0 0 15px 0">Savdo üõí</h2>
        <div id="productGrid" class="grid"></div>
    </div>

    <div id="prodPage" class="page">
        <h2>Ombor üì¶</h2>
        <div style="background: white; padding: 18px; border-radius: 20px; margin-bottom: 20px; border: 1px solid #e2e8f0;">
            <input type="hidden" id="editOldName">
            <input type="text" id="pName" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; border:1px solid #ddd;" placeholder="Mahsulot nomi">
            <input type="number" id="pPrice" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; border:1px solid #ddd;" placeholder="Narxi">
            <button class="btn" onclick="saveProduct()">Saqlash</button>
            <button id="cancelBtn" class="btn" style="background:#94a3b8; margin-top:5px; display:none;" onclick="resetForm()">Bekor</button>
        </div>
        <div id="inventoryList"></div>
    </div>

    <div id="historyPage" class="page">
        <h2>Analitika üìú</h2>
        <div style="display:flex; gap:5px; margin-bottom:15px;">
            <button class="btn" style="padding:10px; font-size:12px" onclick="setSort('time')">üïí Vaqt</button>
            <button class="btn" style="padding:10px; font-size:12px; background:var(--dark)" onclick="setSort('all_items')">üìú Umumiy</button>
            <button class="btn" style="padding:10px; font-size:12px; background:var(--edit)" onclick="setSort('product')">üçé Mahsulot</button>
        </div>
        <div id="historyLogs"></div>
        <button class="btn" style="background:var(--danger); margin-top:20px" onclick="clearAllData()">üóë Tarixni tozalash</button>
    </div>

    <div id="actionBar" class="action-bar">
        <button class="btn-cart" onclick="openCart()">
            üõí <span id="cartCount">0</span>
        </button>
        <button class="btn-pay" onclick="showReceipt()">
            TO'LOV ‚ûî
        </button>
    </div>

    <div class="nav">
        <div class="nav-item nav-active" onclick="openTab('salePage', this)"><span>SOTUV</span></div>
        <div class="nav-item" onclick="openTab('prodPage', this)"><span>OMBOR</span></div>
        <div class="nav-item" onclick="openTab('historyPage', this)"><span>TARIX</span></div>
    </div>

    <div id="weightModal" class="modal"><div class="modal-content" style="text-align:center"><h3 id="selectedName"></h3><input type="number" id="vaznField" style="width:100%; padding:15px; font-size:22px; border-radius:12px; border:1px solid #ddd;" placeholder="0.00 kg" step="0.01"><button class="btn" style="margin-top:15px" onclick="confirmWeight()">TASDIQLASH</button><button class="btn" style="background:#f1f5f9; color:#444; margin-top:10px;" onclick="closeModal('weightModal')">BEKOR</button></div></div>
    
    <div id="cartModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0">Savat üõí</h3>
            <div id="cartItemsList"></div>
            <button class="btn" style="margin-top:20px" onclick="closeModal('cartModal')">YOPISH</button>
        </div>
    </div>

    <div id="chekModal" class="modal">
        <div class="modal-content receipt">
            <div style="text-align:center; border-bottom:1px dashed #000; padding-bottom:10px; margin-bottom:10px;"><b>XARID CHEKI</b></div>
            <div id="chekItems"></div>
            <div style="border-top:1px dashed #000; margin-top:10px; padding-top:10px; font-weight:bold; font-size:20px; text-align:right;">JAMI: <span id="chekTotal"></span></div>
            <button class="btn" style="margin-top:20px;" onclick="finishSale()">‚úÖ SAVDONI YAKUNLASH</button>
            <button class="btn" style="background:var(--danger); margin-top:10px;" onclick="closeModal('chekModal')">BEKOR</button>
        </div>
    </div>

<script>
    let db, cart = [], selected = null, currentSort = 'time', editIndex = null;
    const formatMoney = n => new Intl.NumberFormat('uz-UZ').format(n) + " so'm";

    const req = indexedDB.open("KassaDB_V26", 1);
    req.onupgradeneeded = e => {
        let d = e.target.result;
        d.createObjectStore("items", { keyPath: "name" });
        d.createObjectStore("sales", { autoIncrement: true });
    };
    req.onsuccess = e => { db = e.target.result; renderGrid(); renderInventory(); renderHistory(); };

    function openTab(t, el) { 
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('nav-active'));
        document.getElementById(t).classList.add('active-page'); el.classList.add('nav-active');
        document.getElementById('actionBar').className = (t === 'salePage') ? 'action-bar' : 'action-bar hidden-bar';
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }

    // SAVATNI BOSHQARISH
    function openCart() {
        const list = document.getElementById('cartItemsList');
        list.innerHTML = cart.length ? '' : '<p style="text-align:center; color:#94a3b8">Savat bo\'sh</p>';
        cart.forEach((item, idx) => {
            list.innerHTML += `
                <div class="cart-row">
                    <span style="flex:1"><b>${item.name}</b><br><small>${item.weight} kg x ${item.price.toLocaleString()}</small></span>
                    <b style="margin-right:10px">${item.total.toLocaleString()}</b>
                    <button class="edit-btn" onclick="startEdit(${idx})">‚úèÔ∏è</button>
                    <button class="edit-btn" style="color:var(--danger)" onclick="removeFromCart(${idx})">üóë</button>
                </div>`;
        });
        openModal('cartModal');
    }

    function startEdit(idx) {
        closeModal('cartModal');
        openWeight(cart[idx].name, cart[idx].price, idx);
    }

    function removeFromCart(idx) {
        cart.splice(idx, 1);
        document.getElementById('cartCount').innerText = cart.length;
        openCart();
    }

    // SOTUV
    function renderGrid() {
        const grid = document.getElementById('productGrid'); grid.innerHTML = '';
        db.transaction("items").objectStore("items").getAll().onsuccess = e => {
            e.target.result.forEach(p => { 
                grid.innerHTML += `<div class="prod-card" onclick="openWeight('${p.name}', ${p.price})"><b>${p.name}</b><br><span style="color:var(--main)">${p.price.toLocaleString()}</span></div>`;
            });
        };
    }

    function openWeight(n, p, idx = null) {
        editIndex = idx; selected = { name: n, price: p };
        document.getElementById('selectedName').innerText = n;
        document.getElementById('vaznField').value = idx !== null ? cart[idx].weight : '';
        openModal('weightModal');
        setTimeout(() => document.getElementById('vaznField').focus(), 100);
    }

    function confirmWeight() {
        let w = parseFloat(document.getElementById('vaznField').value);
        if(!w) return;
        if(editIndex !== null) {
            cart[editIndex].weight = w;
            cart[editIndex].total = Math.round(cart[editIndex].price * w);
            editIndex = null;
            openCart(); // Tahrirdan so'ng savatga qaytish
        } else {
            cart.push({ ...selected, weight: w, total: Math.round(selected.price * w) });
        }
        document.getElementById('cartCount').innerText = cart.length;
        closeModal('weightModal');
    }

    function showReceipt() {
        if(!cart.length) return alert("Savat bo'sh!");
        let t = 0;
        document.getElementById('chekItems').innerHTML = cart.map(i => {
            t += i.total;
            return `<div style="display:flex; justify-content:space-between; margin-bottom:5px"><span>${i.name} (${i.weight}kg)</span><b>${i.total.toLocaleString()}</b></div>`;
        }).join('');
        document.getElementById('chekTotal').innerText = t.toLocaleString() + " so'm";
        openModal('chekModal');
    }

    function finishSale() {
        let t = cart.reduce((a, b) => a + b.total, 0);
        db.transaction("sales", "readwrite").objectStore("sales").add({ 
            date: new Date().toLocaleDateString('uz-UZ'), 
            time: new Date().toLocaleTimeString('uz-UZ'), 
            items: [...cart], total: t, ts: Date.now() 
        });
        cart = []; document.getElementById('cartCount').innerText = "0";
        closeModal('chekModal'); renderHistory();
    }

    // OMBOR VA TARIX (O'zgarmadi)
    function saveProduct() {
        let n = document.getElementById('pName').value, p = parseFloat(document.getElementById('pPrice').value), old = document.getElementById('editOldName').value;
        if(!n || !p) return;
        let tx = db.transaction("items", "readwrite");
        if(old && old !== n) tx.objectStore("items").delete(old);
        tx.objectStore("items").put({ name: n, price: p });
        tx.oncomplete = () => { resetForm(); renderGrid(); renderInventory(); };
    }
    function renderInventory() {
        const list = document.getElementById('inventoryList'); list.innerHTML = '';
        db.transaction("items").objectStore("items").getAll().onsuccess = e => {
            e.target.result.forEach(p => { 
                list.innerHTML += `<div class="list-item"><span><b>${p.name}</b><br><small>${formatMoney(p.price)}</small></span>
                <div><button onclick="editItem('${p.name}', ${p.price})" class="edit-btn">‚úèÔ∏è</button>
                <button onclick="deleteItem('${p.name}')" class="edit-btn" style="color:var(--danger)">üóë</button></div></div>`;
            });
        };
    }
    function editItem(n, p) { document.getElementById('pName').value = n; document.getElementById('pPrice').value = p; document.getElementById('editOldName').value = n; document.getElementById('cancelBtn').style.display = 'block'; window.scrollTo(0,0); }
    function resetForm() { document.getElementById('pName').value = ''; document.getElementById('pPrice').value = ''; document.getElementById('editOldName').value = ''; document.getElementById('cancelBtn').style.display = 'none'; }
    function deleteItem(n) { if(confirm("O'chirilsinmi?")) { db.transaction("items", "readwrite").objectStore("items").delete(n); renderGrid(); renderInventory(); } }

    function setSort(s) { currentSort = s; renderHistory(); }
    function renderHistory() {
        const logs = document.getElementById('historyLogs'); logs.innerHTML = '';
        db.transaction("sales").objectStore("sales").getAll().onsuccess = e => { 
            const sales = e.target.result;
            if(currentSort === 'time') {
                sales.reverse().slice(0, 50).forEach(h => { 
                    logs.innerHTML += `<div class="list-item"><span><small>${h.date} ${h.time}</small><br><b>${h.total.toLocaleString()} so'm</b></span></div>`; 
                }); 
            } else if(currentSort === 'product') {
                let stats = {};
                sales.forEach(s => s.items.forEach(i => { if(!stats[i.name]) stats[i.name]={w:0, s:0}; stats[i.name].w+=i.weight; stats[i.name].s+=i.total; }));
                Object.keys(stats).forEach(k => { logs.innerHTML += `<div class="list-item"><b>${k}</b><span>${stats[k].w.toFixed(2)}kg / ${stats[k].s.toLocaleString()}</span></div>`; });
            } else {
                sales.forEach(s => s.items.forEach(i => { logs.innerHTML += `<div class="list-item" style="font-size:12px"><span>${s.time} - <b>${i.name}</b></span><b>${i.weight}kg</b></div>`; }));
            }
        };
    }
    function clearAllData() { if(confirm("Tarix o'chirilsinmi?")) { db.transaction("sales", "readwrite").objectStore("sales").clear(); renderHistory(); } }
</script>
</body>
</html>
